"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _torrentStream=require("torrent-stream");var _torrentStream2=_interopRequireDefault(_torrentStream);var _http=require("http");var _http2=_interopRequireDefault(_http);var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);var _rangeParser=require("range-parser");var _rangeParser2=_interopRequireDefault(_rangeParser);var _xtend=require("xtend");var _xtend2=_interopRequireDefault(_xtend);var _url=require("url");var _url2=_interopRequireDefault(_url);var _mime=require("mime");var _mime2=_interopRequireDefault(_mime);var _pump=require("pump");var _pump2=_interopRequireDefault(_pump);var _optimist=require("optimist");var _optimist2=_interopRequireDefault(_optimist);var _rc=require("rc");var _rc2=_interopRequireDefault(_rc);var _clivas=require("clivas");var _clivas2=_interopRequireDefault(_clivas);var _numeral=require("numeral");var _numeral2=_interopRequireDefault(_numeral);var _networkAddress=require("network-address");var _networkAddress2=_interopRequireDefault(_networkAddress);var _open=require("open");var _open2=_interopRequireDefault(_open);var _path=require("path");var _path2=_interopRequireDefault(_path);var _util=require("util");var _util2=_interopRequireDefault(_util);var _child_process=require("child_process");var _events=require("events");var _events2=_interopRequireDefault(_events);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var enc=function enc(s){return/\s/.test(s)?JSON.stringify(s):s};var Torrent2VLC=function(_EventEmitter){_inherits(Torrent2VLC,_EventEmitter);function Torrent2VLC(props){_classCallCheck(this,Torrent2VLC);var _this=_possibleConstructorReturn(this,(Torrent2VLC.__proto__||Object.getPrototypeOf(Torrent2VLC)).call(this));_this.torrent=props;return _this}_createClass(Torrent2VLC,[{key:"startStream",value:function startStream(index){var _this2=this;this.engine=(0,_torrentStream2.default)(this.torrent);this.engine.on("ready",function(){_this2.engine.server=_this2.createStreamServer(index);_this2.engine.server.listen(0,"localhost");_this2.engine.listen();var hotswaps=0;var verified=0;var invalid=0;var downloadedPercentage=0;var started=Date.now();var wires=_this2.engine.swarm.wires;var swarm=_this2.engine.swarm;_this2.engine.on("verify",function(){verified++;downloadedPercentage=Math.floor(verified/_this2.engine.torrent.pieces.length*100)});_this2.engine.on("invalid-piece",function(){invalid++});_this2.engine.on("hotswap",function(){hotswaps++});_this2.engine.server.on("listening",function(){console.log("engine listening");_this2.engine.files[index].select();var logStatus=function logStatus(){var unchoked=_this2.engine.swarm.wires.filter(function(wire){return!wire.peerChoking});var runtime=Math.floor((Date.now()-started)/1e3);var status={downloadSpeed:_this2.getFormattedByteNumber(swarm.downloadSpeed()),downloadedSize:_this2.getFormattedByteNumber(swarm.downloaded),uploadedSize:_this2.getFormattedByteNumber(swarm.uploaded),downloadedPercentage:downloadedPercentage,streamPath:_this2.engine.path,unchoked:unchoked.length,wires:wires.length,runtime:runtime,hotswaps:hotswaps,verified:verified,invalid:invalid,queued:swarm.queued};_this2.emit("status-update",status)};setInterval(logStatus,500);logStatus()});_this2.engine.server.once("error",function(){_this2.engine.server.listen(0,"localhost")})})}},{key:"getFormattedByteNumber",value:function getFormattedByteNumber(number){return(0,_numeral2.default)(number).format("0.0b")}},{key:"getFileList",value:function getFileList(){var _this3=this;return new Promise(function(resolve){_this3.engine=(0,_torrentStream2.default)(_this3.torrent);_this3.engine.on("ready",function(){var choices=_this3.engine.files.map(function(file,index){return{name:file.name,size:_this3.getFormattedByteNumber(file.length),value:index}});resolve(choices)})})}},{key:"startVLC",value:function startVLC(){var href="http://localhost:"+this.engine.server.address().port+"/.m3u";console.log(href);var root="/Applications/VLC.app/Contents/MacOS/VLC";var home=(process.env.HOME||"")+root;var vlc=(0,_child_process.exec)("vlc --video-on-top --play-and-exit "+href+" || "+root+" "+href,function(error,stdout,stderror){if(error)process.exit(0)});vlc.on("exit",function(){process.exit(0)})}},{key:"createStreamServer",value:function createStreamServer(index){var _this4=this;var server=_http2.default.createServer();var getType=_mime2.default.lookup.bind(_mime2.default);server.on("request",function(request,response){var u=_url2.default.parse(request.url);var host="localhost";var file=_this4.engine.files[index];var range=request.headers.range;var toJSON=function toJSON(){var totalPeers=_this4.engine.swarm.wires;var activePeers=totalPeers.filter(function(wire){return!wire.peerChoking});var swarmStats={downloaded:_this4.engine.swarm.downloaded,uploaded:_this4.engine.swarm.uploaded,downloadSpeed:parseInt(_this4.engine.swarm.downloadSpeed(),10),uploadSpeed:parseInt(_this4.engine.swarm.uploadSpeed(),10),totalPeers:totalPeers.length,activePeers:activePeers.length};return JSON.stringify(swarmStats,null,"  ")};if(request.method==="OPTIONS"&&request.headers["access-control-request-headers"]){response.setHeader("Access-Control-Allow-Origin",request.headers.origin);response.setHeader("Access-Control-Allow-Methods","POST, GET, OPTIONS");response.setHeader("Access-Control-Allow-Headers",request.headers["access-control-request-headers"]);response.setHeader("Access-Control-Max-Age","1728000");response.end();return}if(request.headers.origin)response.setHeader("Access-Control-Allow-Origin",request.headers.origin);if(u.pathname==="/favicon.ico"){response.statusCode=404;response.end();return}if(u.pathname==="/.json"){var json=toJSON();response.setHeader("Content-Type","application/json; charset=utf-8");response.setHeader("Content-Length",Buffer.byteLength(json));response.end(json);return}if(u.pathname==="/.m3u"){var playlist="#EXTM3U\n#EXTINF:-1,"+file.path+"\n"+"http://localhost:"+_this4.engine.server.address().port;response.setHeader("Content-Type","application/x-mpegurl; charset=utf-8");response.setHeader("Content-Length",Buffer.byteLength(playlist));response.end(playlist);return}range=range&&(0,_rangeParser2.default)(file.length,range)[0];response.setHeader("Accept-Ranges","bytes");response.setHeader("Content-Type",getType(file.name));response.setHeader("transferMode.dlna.org","Streaming");response.setHeader("contentFeatures.dlna.org","DLNA.ORG_OP=01;DLNA.ORG_CI=0;DLNA.ORG_FLAGS=017000 00000000000000000000000000");if(!range){response.setHeader("Content-Length",file.length);if(request.method==="HEAD")return response.end();(0,_pump2.default)(file.createReadStream(),response);return}response.statusCode=206;response.setHeader("Content-Length",range.end-range.start+1);response.setHeader("Content-Range","bytes "+range.start+"-"+range.end+"/"+file.length);if(request.method==="HEAD")return response.end();(0,_pump2.default)(file.createReadStream(range),response)});server.on("connection",function(socket){socket.setTimeout(36e6)});return server}}]);return Torrent2VLC}(_events2.default);exports.default=Torrent2VLC;